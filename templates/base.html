from flask import Flask, render_template, redirect, url_for, request, session, abort
import pymysql
from datetime import time

app = Flask(__name__)
app.secret_key = 'your_secret_key_here'  # 设置安全密钥

# 注册时间格式化过滤器（与之前解决方案一致）
@app.template_filter('format_time')
def format_time_filter(value):
    if isinstance(value, time):
        return value.strftime('%H:%M')
    elif isinstance(value, str) and len(value) >= 5:
        return value[:5]
    return value

# 课程列表路由
@app.route('/admin/courses')
def manage_courses():
    # 权限验证
    if 'role' not in session or session['role'] != 'admin':
        abort(403)  # 禁止无权限访问

    conn = None
    try:
        conn = get_db_connection()  # 假设已实现数据库连接方法
        with conn.cursor(pymysql.cursors.DictCursor) as cursor:
            # 获取课程详细信息
            cursor.execute('''
                SELECT
                    c.id,
                    c.name,
                    c.credit,
                    d.name AS department_name,
                    u.fullname AS teacher_name,
                    ts.weekday,
                    ts.start_time,
                    ts.end_time,
                    cl.building,
                    cl.room_number
                FROM courses c
                JOIN departments d ON c.department_id = d.id
                JOIN users u ON c.teacher_id = u.id
                JOIN time_slots ts ON c.time_slot_id = ts.id
                JOIN classrooms cl ON c.classroom_id = cl.id
                ORDER BY c.id DESC
            ''')
            courses = cursor.fetchall()

        return render_template('course_management.html', courses=courses)

    except pymysql.Error as e:
        print(f"数据库错误: {e}")
        return render_template('error.html', message="课程数据加载失败"), 500
    finally:
        if conn:
            conn.close()

# 删除课程路由
@app.route('/delete-course', methods=['POST'])
def delete_course():
    # 管理员权限验证
    if 'role' not in session or session['role'] != 'admin':
        abort(403)

    course_id = request.form.get('course_id')
    if not course_id or not course_id.isdigit():
        return "无效的课程ID", 400

    conn = None
    try:
        conn = get_db_connection()
        with conn.cursor() as cursor:
            # 检查关联选课记录
            cursor.execute('''
                SELECT COUNT(*) AS enroll_count
                FROM enrollments
                WHERE course_id = %s
            ''', (course_id,))
            result = cursor.fetchone()

            if result['enroll_count'] > 0:
                return "请先删除相关选课记录", 400

            # 执行删除
            cursor.execute('DELETE FROM courses WHERE id = %s', (course_id,))
            conn.commit()

        return redirect(url_for('manage_courses'))

    except pymysql.Error as e:
        print(f"删除失败: {e}")
        if conn:
            conn.rollback()
        return "课程删除失败", 500
    finally:
        if conn:
            conn.close()

def get_db_connection():
    """示例数据库连接方法，需根据实际配置修改"""
    return pymysql.connect(
        host='localhost',
        user='your_username',
        password='your_password',
        database='course_system',
        charset='utf8mb4',
        cursorclass=pymysql.cursors.DictCursor
    )