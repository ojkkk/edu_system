{% extends "layout.html" %}
{% block title %}è¯¾ç¨‹ç®¡ç†{% endblock %}
{% block content %}
<div class="card course-management-card">
    <!-- å¤´éƒ¨æ“ä½œæ  -->
    <div class="management-header">
        <h2 class="management-title">
            <a href="{{ url_for('teacher_dashboard') }}" class="back-btn">
                â†
            </a>
            è¯¾ç¨‹å­¦ç”Ÿç®¡ç†
        </h2>
        <div class="header-actions">
            <a href="{{ url_for('teacher_dashboard') }}" class="btn btn-secondary">
                ğŸ  è¿”å›æ•™å¸ˆä¸»é¡µ
            </a>
        </div>
    </div>

    <!-- æ·»åŠ å­¦ç”Ÿè¡¨å• -->
    <div class="add-student-section">
        <form method="POST" action="{{ url_for('add_student_to_course') }}">
            <input type="hidden" name="course_id" value="{{ course_id }}">
            <div class="form-inline">
                <input type="text"
                       name="username"
                       placeholder="è¾“å…¥å­¦ç”Ÿç”¨æˆ·å"
                       class="modern-input"
                       required>
                <button class="btn btn-primary" type="submit">
                    â• æ·»åŠ å­¦ç”Ÿ
                </button>
            </div>
        </form>
    </div>

    <!-- æˆç»©è¡¨æ ¼ -->
    <div class="grade-table-container">
        <table class="grade-table">
            <thead>
                <tr>
                    <th>å­¦ç”Ÿå§“å</th>
                    <th>å¹³æ—¶æˆç»©</th>
                    <th>æœŸæœ«æˆç»©</th>
                    <th>æ€»è¯„æˆç»©</th>
                    <th>æ“ä½œ</th>
                </tr>
            </thead>
            <tbody>
                {% for student in students %}
                <tr>
                    <td class="student-name">{{ student.fullname }}</td>
                    <form method="POST" action="{{ url_for('update_grades') }}">
                        <input type="hidden" name="course_id" value="{{ course_id }}">
                        <input type="hidden" name="student_id" value="{{ student.id }}">

                        <td>
                            <input type="number"
                                   name="usual_grade"
                                   value="{{ student.usual_grade if student.usual_grade is not none }}"
                                   step="0.1"
                                   min="0"
                                   max="100"
                                   class="grade-input"
                                   required>
                        </td>
                        <td>
                            <input type="number"
                                   name="final_grade"
                                   value="{{ student.final_grade if student.final_grade is not none }}"
                                   step="0.1"
                                   min="0"
                                   max="100"
                                   class="grade-input"
                                   required>
                        </td>
                             <td class="total-grade" id="total-{{ student.id }}">
                                    {% if student.usual_grade and student.final_grade %}
                                     {{ "%.1f"|format(student.usual_grade * 0.3 + student.final_grade * 0.7) }}
                                    {% else %}
                                         <span class="na">-</span>
                                    {% endif %}
                             </td>

                        <td>
                            <button class="btn btn-save"
                                    type="submit"
                                    onclick="return confirm('ç¡®è®¤æ›´æ–°æˆç»©ï¼Ÿ')">
                                æ›´æ–°
                            </button>
                        </td>
                    </form>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<style>
/* å¡ç‰‡å®¹å™¨ */
.course-management-card {
    background: #ffffff;
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.08);
    padding: 2rem;
}

/* å¤´éƒ¨æ ·å¼ */
.management-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
    padding-bottom: 1.5rem;
    border-bottom: 2px solid #f0f0f0;
}

.management-title {
    display: flex;
    align-items: center;
    color: #6a1b9a;
    margin: 0;
}

.back-btn {
    color: #6a1b9a;
    text-decoration: none;
    font-size: 1.5em;
    margin-right: 1rem;
    transition: transform 0.2s;
}

.back-btn:hover {
    transform: translateX(-3px);
}

/* æ·»åŠ å­¦ç”Ÿè¡¨å• */
.add-student-section {
    margin-bottom: 2.5rem;
}

.form-inline {
    display: flex;
    gap: 1rem;
    max-width: 600px;
}

.modern-input {
    flex: 1;
    padding: 0.8rem 1.2rem;
    border: 2px solid #e0e0e0;
    border-radius: 8px;
    transition: border-color 0.3s;
}

.modern-input:focus {
    border-color: #6a1b9a;
    outline: none;
    box-shadow: 0 0 8px rgba(106,27,154,0.15);
}

/* æˆç»©è¡¨æ ¼ */
.grade-table-container {
    overflow-x: auto;
}

.grade-table {
    width: 100%;
    border-collapse: collapse;
    background: white;
    min-width: 800px;
}

.grade-table th {
    background: #f8f5fc;
    color: #6a1b9a;
    padding: 1.2rem;
    font-weight: 600;
}

.grade-table td {
    padding: 1rem;
    border-bottom: 1px solid #f0f0f0;
}

.grade-table tr:hover td {
    background: #fcfaff;
}

/* è¾“å…¥æ¡†æ ·å¼ */
.grade-input {
    width: 100px;
    padding: 0.5rem;
    border: 2px solid #e0e0e0;
    border-radius: 6px;
    text-align: center;
}

.grade-input:focus {
    border-color: #6a1b9a;
}

/* æ€»è¯„æˆç»© */
.total-grade {
    color: #2ecc71;
    font-weight: 600;
    font-size: 1.1em;
}

.na {
    color: #95a5a6;
    font-style: italic;
}

/* æ“ä½œæŒ‰é’® */
.btn-save {
    background: #6a1b9a;
    color: white !important;
    padding: 0.6rem 1.2rem;
    border-radius: 20px;
    transition: all 0.2s;
}

.btn-save:hover {
    background: #4a148c;
    transform: translateY(-1px);
}

.btn-secondary {
    background: #9c27b0;
    color: white;
    padding: 0.8rem 1.5rem;
    border-radius: 8px;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
}

.btn-secondary:hover {
    background: #6a1b9a;
}

/* å“åº”å¼è®¾è®¡ */
@media (max-width: 768px) {
    .management-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 1rem;
    }

    .form-inline {
        flex-direction: column;
    }

    .modern-input {
        width: 100%;
    }
}
/* æ€»è¯„æˆç»©çŠ¶æ€æ ·å¼ */
.total-grade.excellent { color: #4CAF50; }  /* ä¼˜ç§€ï¼šç»¿è‰² */
.total-grade.good { color: #8BC34A; }      /* è‰¯å¥½ï¼šæµ…ç»¿ */
.total-grade.medium { color: #FFC107; }   /* ä¸­ç­‰ï¼šé»„è‰² */
.total-grade.pass { color: #FF9800; }     /* åŠæ ¼ï¼šæ©™è‰² */
.total-grade.fail { color: #F44336; }     /* ä¸åŠæ ¼ï¼šçº¢è‰² */
</style>
<script>
// ä¸ºæ‰€æœ‰æˆç»©è¾“å…¥æ¡†ç»‘å®šå®æ—¶è®¡ç®—äº‹ä»¶
document.querySelectorAll('.grade-input').forEach(input => {
    input.addEventListener('input', function() {
        // è·å–å½“å‰è¡Œçš„è¡¨å•å…ƒç´ 
        const row = this.closest('tr');
        const usualInput = row.querySelector('input[name="usual_grade"]');
        const finalInput = row.querySelector('input[name="final_grade"]');
        const totalCell = row.querySelector('.total-grade');

        // è·å–æ•°å€¼å¹¶è¿›è¡ŒéªŒè¯
        const usual = parseFloat(usualInput.value) || null;
        const final = parseFloat(finalInput.value) || null;

        // è®¡ç®—å’Œæ˜¾ç¤ºæ€»è¯„æˆç»©
        if (usual !== null && final !== null) {
            const total = (usual * 0.3 + final * 0.7).toFixed(1);
            totalCell.textContent = total;
            updateGradeStatus(totalCell, total);
        } else {
            totalCell.textContent = '-';
            totalCell.className = 'total-grade'; // é‡ç½®æ ·å¼
        }
    });
});

// æ›´æ–°æˆç»©çŠ¶æ€æ ·å¼
function updateGradeStatus(element, total) {
    element.className = 'total-grade'; // é‡ç½®åŸºç¡€æ ·å¼
    if (total >= 90) element.classList.add('excellent');
    else if (total >= 80) element.classList.add('good');
    else if (total >= 70) element.classList.add('medium');
    else if (total >= 60) element.classList.add('pass');
    else element.classList.add('fail');
}
</script>
{% endblock %}